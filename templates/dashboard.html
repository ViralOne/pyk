{% extends "base.html" %}

{% block title %}Kubernetes Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-th-large"></i> Namespaces</h2>
    
    <div class="pure-form">
        <div class="search-box">
            <input type="text" id="namespace-search" name="namespace" placeholder="Search namespaces..." autocomplete="off">
        </div>
    </div>

    <div id="namespaceGrid" class="namespace-grid">
        <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading namespaces...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    function loadNamespaceData(namespace) {
        return $.get(`/api/pods/${namespace}`).then(data => {
            const stats = {
                running: 0,
                failed: 0,
                pending: 0
            };
            
            data.forEach(pod => {
            const health = pod.health || 'unknown';
            switch (health) {
                case 'healthy':
                    stats.running++;
                    break;
                case 'unhealthy':
                    stats.failed++;
                    break;
                case 'unknown':
                    console.warn(`Unknown health status for pod: ${pod.name}`);
                    // fallthrough
                default:
                    stats.pending++;
            }
            });
            
            return stats;
        });
    }
    
    function updateNamespaceCard(namespace, stats) {
        return `
            <div class="namespace-card">
                <div class="namespace-header">
                    <h3>${namespace}</h3>
                    <div class="health-indicator">
                        ${stats.running > 0 ? '<span class="health-dot healthy" title="Running pods"></span>' : ''}
                        ${stats.failed > 0 ? '<span class="health-dot unhealthy" title="Failed pods"></span>' : ''}
                        ${stats.pending > 0 ? '<span class="health-dot warning" title="Pending pods"></span>' : ''}
                    </div>
                </div>
                <div class="namespace-stats">
                    <div class="stat-item">
                        <div class="stat-value">${stats.running}</div>
                        <div class="stat-label">Running</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.failed + stats.pending}</div>
                        <div class="stat-label">Issues</div>
                    </div>
                </div>
                <a href="/namespace/${namespace}" class="view-details">
                    <i class="fas fa-arrow-right"></i> View Details
                </a>
            </div>
        `;
    }
    
    // Load namespaces
    $.get('/api/namespaces', function(namespaces) {
        const grid = $('#namespaceGrid');
        grid.empty();
        
        if (!Array.isArray(namespaces) || namespaces.length === 0) {
            grid.html(`
                <div class="loading">
                    <i class="fas fa-info-circle"></i>
                    <p>No namespaces found</p>
                </div>
            `);
            return;
        }
        
        // Show loading state
        grid.html(`
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading namespace information...</p>
            </div>
        `);
        
        // Load health data for each namespace
        const promises = namespaces.map(ns => 
            loadNamespaceData(ns).then(stats => ({
                namespace: ns,
                stats: stats
            })).catch(() => ({
                namespace: ns,
                stats: { running: 0, failed: 0, pending: 0 }
            }))
        );
        
        Promise.all(promises).then(results => {
            const cardsHtml = results.map(result => 
                updateNamespaceCard(result.namespace, result.stats)
            ).join('');
            
            grid.html(cardsHtml);
            
            // Initialize search functionality
            $('#namespace-search').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                $('.namespace-card').each(function() {
                    const namespaceName = $(this).find('h3').text().toLowerCase();
                    $(this).toggle(namespaceName.includes(searchTerm));
                });
            });
        }).catch(() => {
            grid.html(`
                <div class="loading">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Error loading namespace information. Please try again later.</p>
                </div>
            `);
        });
    }).fail(function() {
        $('#namespaceGrid').html(`
            <div class="loading">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading namespaces. Please try again later.</p>
            </div>
        `);
    });
});
</script>
{% endblock %}
